# =============================================================================
# FamilyFinance - Docker Compose (Production)
# Location: /srv/scram-apps/Family-Finance/docker-compose.yml
# =============================================================================

version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: family-finance-api
    image: scram2k/family-finance:latest
    restart: unless-stopped

    # Environment configuration
    env_file:
      - .env

    # Volume mounts (read-only where possible)
    volumes:
      - ./secrets/gcp-key.json:/app/secrets/gcp-key.json:ro

    # Network configuration
    networks:
      - traefik-public
      - internal-db-net
      - scram-network

    # Resource limits (Critical for shared infrastructure)
    deploy:
      resources:
        limits:
          cpus: '0.50'      # Max 50% of one core
          memory: 450M      # Hard limit (below 512MB threshold)
        reservations:
          cpus: '0.25'
          memory: 200M      # Guaranteed minimum

    # Logging configuration (prevent disk fill)
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Traefik labels for reverse proxy
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      # Use traefik-public network for routing (container is in multiple networks)
      - "traefik.docker.network=traefik-public"

      # Router configuration
      - "traefik.http.routers.family.rule=Host(`Family-Finance.scram2k.com`)"
      - "traefik.http.routers.family.entrypoints=websecure"
      - "traefik.http.routers.family.tls.certresolver=letsencrypt"

      # Service configuration
      - "traefik.http.services.family.loadbalancer.server.port=8000"

      # Middlewares for security
      - "traefik.http.routers.family.middlewares=secure-headers,compress-res,rate-limit"

      # Security headers middleware
      - "traefik.http.middlewares.secure-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.secure-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.secure-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.secure-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.secure-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.secure-headers.headers.frameDeny=true"

      # Compression middleware
      - "traefik.http.middlewares.compress-res.compress=true"

      # Rate limiting middleware
      - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health', timeout=2).raise_for_status()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Frontend Web App (Expo)
  frontend:
    build:
      context: ./mobile
      dockerfile: Dockerfile
      args:
        EXPO_PUBLIC_API_URL: https://Family-Finance.scram2k.com
        EXPO_PUBLIC_GEMINI_API_KEY: ${EXPO_PUBLIC_GEMINI_API_KEY:-}
    container_name: family-finance-web
    image: scram2k/family-finance-web:latest
    restart: unless-stopped

    # Network configuration
    networks:
      - traefik-public

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.10'
          memory: 64M

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

    # Traefik labels for reverse proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # Router configuration - app subdomain (lowercase for Cloudflare compatibility)
      - "traefik.http.routers.family-web.rule=Host(`app.family-finance.scram2k.com`)"
      - "traefik.http.routers.family-web.entrypoints=websecure"
      - "traefik.http.routers.family-web.tls.certresolver=letsencrypt"

      # Service configuration
      - "traefik.http.services.family-web.loadbalancer.server.port=80"

      # Security middlewares
      - "traefik.http.routers.family-web.middlewares=secure-headers,compress-res"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# External networks (managed by infrastructure)
networks:
  traefik-public:
    external: true
  internal-db-net:
    external: true
  scram-network:
    external: true
    name: saas-platform_scram-network
